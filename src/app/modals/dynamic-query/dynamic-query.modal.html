<ub-tabs>
  <ub-tab label="Configuração">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="p-fluid p-formgrid grid">

        <div class="col-12 md:col-6">
          <ub-input
            label="Nome"
            placeholder="Digite o nome da consulta"
            formControlName="name"
            [error]="FormErrorHandlerService.getError('name', errors)"
            (blur)="generateKey($event)"
          ></ub-input>
        </div>

        <div class="col-12 md:col-6">
          <ub-input
            label="Chave"
            placeholder="Digite a chave única da consulta"
            formControlName="key"
            [error]="FormErrorHandlerService.getError('key', errors)"
          ></ub-input>
        </div>

        <div class="col-12">
          <ub-textarea
            label="Descrição"
            placeholder="Descrição da consulta"
            formControlName="description"
            [error]="FormErrorHandlerService.getError('description', errors)"
          ></ub-textarea>
        </div>

        <div class="col-12">
          <ub-dropdown
            label="Serviço"
            placeholder="Escolha o serviço de consulta"
            formControlName="service_slug"
            [error]="FormErrorHandlerService.getError('service_slug', errors)"
            [options]="services"
            optionLabel="name" optionValue="slug" optionDescription="description"
          ></ub-dropdown>
        </div>

      </div>

      <!-- Botão de Salvar -->
      <div class="flex justify-content-end gap-2">
        <ub-button type="submit" [disabled]="form.invalid" [loading]="loading">Salvar</ub-button>
      </div>
    </form>
  </ub-tab>

  @if (dynamicQuery) {
    <ub-tab label="Parâmetros">
      <app-service-parameters
        [dynamicQuery]="dynamicQuery"
        [serviceSlug]="form.get('service_slug')?.value"
        [companyId]="companyId">
      </app-service-parameters>
    </ub-tab>

    <ub-tab label="Filtros">
      <app-dynamic-query-filters
        [queryKey]="dynamicQueryKey!"
        [companyId]="companyId">
      </app-dynamic-query-filters>
    </ub-tab>

    <ub-tab label="Teste">
      <div class="test-container">

        <!-- Cabeçalho com ações -->
        <div class="flex justify-content-between align-items-center mb-4">
          <h3 class="m-0">Testar Consulta Dinâmica</h3>
          <div class="flex gap-2">
            <ub-button
              type="button"
              (click)="clearTestResult()"
              [disabled]="!hasTestResult || testLoading">
              Limpar Resultado
            </ub-button>
            <ub-button
              type="button"
              (click)="executeTest()"
              [loading]="testLoading">
              Executar Teste
            </ub-button>
          </div>
        </div>

        <!-- Loading -->
        <div class="text-center p-4" *ngIf="testLoading">
          <i class="pi pi-spin pi-spinner text-2xl"></i>
          <p class="mt-2">Executando teste...</p>
        </div>

        <!-- Resultado do teste -->
        <div class="test-result" *ngIf="hasTestResult && !testLoading">

          <!-- Status e Mensagem -->
          <div class="mb-4">
            <div class="flex align-items-center gap-2 mb-2">
              <i class="pi"
                 [ngClass]="isTestSuccessful ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'">
              </i>
              <span class="font-semibold text-lg">
                {{ isTestSuccessful ? 'Sucesso' : 'Erro' }}
              </span>
            </div>

            <div class="p-3 border-round"
                 [ngClass]="isTestSuccessful ? 'bg-green-50 text-green-900 border-green-200' : 'bg-red-50 text-red-900 border-red-200'">
              <p class="m-0">{{ testResult?.message || 'Sem mensagem disponível' }}</p>
            </div>
          </div>

          <!-- Dados (quando sucesso) -->
          <div class="mb-4" *ngIf="isTestSuccessful && hasTestData">
            <h4 class="text-primary mb-3">
              <i class="pi pi-database mr-2"></i>
              {{ getInfoResult() }}
            </h4>
            <div class="data-viewer border-1 border-300 border-round p-3">
              <ngx-json-viewer
                [json]="testResult?.data"
                [expanded]="false">
              </ngx-json-viewer>
            </div>
          </div>

          <!-- Dados vazios -->
          <div class="mb-4" *ngIf="isTestSuccessful && !hasTestData">
            <div class="text-center p-4 bg-yellow-50 border-round border-yellow-200">
              <i class="pi pi-info-circle text-yellow-600 text-2xl"></i>
              <p class="mt-2 text-yellow-900">Consulta executada com sucesso, mas nenhum dado foi retornado.</p>
            </div>
          </div>

          <!-- Erros (quando houver) -->
          <div class="mb-4" *ngIf="hasTestErrors">
            <h4 class="text-red-600 mb-3">
              <i class="pi pi-exclamation-triangle mr-2"></i>
              Erros ({{ testResult?.errors?.length }})
            </h4>
            <div class="errors-viewer border-1 border-red-200 border-round p-3 bg-red-50">
              <ngx-json-viewer
                [json]="testResult?.errors"
                [expanded]="true">
              </ngx-json-viewer>
            </div>
          </div>

          <!-- Metadata (quando houver) -->
          <div class="mb-4" *ngIf="hasTestMetadata">
            <h4 class="text-blue-600 mb-3">
              <i class="pi pi-info mr-2"></i>
              Metadados
            </h4>
            <div class="metadata-viewer border-1 border-blue-200 border-round p-3 bg-blue-50">
              <ngx-json-viewer
                [json]="testResult?.metadata"
                [expanded]="true">
              </ngx-json-viewer>
            </div>
          </div>

        </div>

        <!-- Estado inicial -->
        <div class="text-center p-5" *ngIf="!hasTestResult && !testLoading">
          <i class="pi pi-play-circle text-6xl text-400 mb-3"></i>
          <h4 class="text-600">Pronto para testar</h4>
          <p class="text-500">Configure os parâmetros necessários e clique em "Executar Teste" para testar sua consulta.</p>
        </div>

      </div>
    </ub-tab>
  }
</ub-tabs>
