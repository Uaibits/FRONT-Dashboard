<div class="service-params-container">
  @if (!loading && !hasParameters) {
    <div class="no-params-message">
      <div class="text-center p-6">
        <i class="pi pi-info-circle text-4xl text-blue-500 mb-3"></i>
        <h3 class="text-lg font-medium text-gray-700 mb-2">Nenhum parâmetro configurável</h3>
        <p class="text-gray-500">Este componente não possui parâmetros que precisam ser configurados.</p>
      </div>
    </div>
  }

  @if (!loading && hasParameters) {
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      @for (group of getGroupNames(); track group.trim()) {
        <div class="param-group mb-4">

          @if (getGroupNames().length > 1) {
            <div class="group-header mb-3">
              <h4 class="text-md font-semibold text-gray-800 capitalize border-b border-gray-200 pb-2">
                {{ getGroupDisplayName(group) }}
              </h4>
            </div>
          }

          <div class="p-fluid p-formgrid grid">
            @for (param of dynamicParams[group]; track param.name) {
              @if (shouldShowParameter(param)) {
                <div [class]="getColumnClass(param)">

                  <!-- OAuth Connect -->
                  @if (param.type === 'oauth_connect') {
                    <ub-oauth-connect
                      [label]="param.label || getDefaultLabel(param.name)"
                      [description]="param.description"
                      [provider]="getOAuthProvider(param)"
                      [disabled]="disabled"
                      [integrationName]="integrationName || ''"
                      (disconnected)="onOAuthDisconnected(param)"
                    ></ub-oauth-connect>
                  }

                  <!-- Dynamic Select -->
                  @if (param.type === 'dynamic_select') {
                    <ub-dynamic-select
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || getDefaultPlaceholder(param)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      [error]="getFieldError(param.name)"
                      [url]="param.url || ''"
                      [listPath]="param.listPath || 'data'"
                      [fieldValue]="param.fieldValue || 'id'"
                      [fieldLabel]="param.fieldLabel || 'name'"
                      [reloadTriggers]="param.reloadTriggers || []"
                    ></ub-dynamic-select>
                  }

                  <!-- Input de Texto/URL/Email -->
                  @if (isTextInput(param)) {
                    <ub-input
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || getDefaultPlaceholder(param)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [type]="getInputType(param)"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      [error]="getFieldError(param.name)">
                    </ub-input>
                  }

                  <!-- Dropdown/Select -->
                  @if (param.type === 'select') {
                    <ub-dropdown
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || 'Selecione uma opção'"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [options]="getSelectOptions(param)"
                      [helpText]="param.description || ''"
                      [error]="getFieldError(param.name)">
                    </ub-dropdown>
                  }

                  <!-- MultiSelect -->
                  @if (param.type === 'multiselect') {
                    <ub-multiselect
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || 'Selecione as opções'"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [options]="getSelectOptions(param)"
                      [error]="getFieldError(param.name)">

                      @if (param.description) {
                        <small class="help-text">
                          <i class="pi pi-info-circle mr-1"></i>{{ param.description }}
                        </small>
                      }
                    </ub-multiselect>
                  }

                  <!-- Toggle Switch (Boolean) -->
                  @if (param.type === 'boolean') {
                    <ub-toggle-switch
                      [label]="param.label || getDefaultLabel(param.name)"
                      [formControlName]="param.name"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      [error]="getFieldError(param.name)">
                    </ub-toggle-switch>
                  }

                  <!-- Número -->
                  @if (param.type === 'number') {
                    <ub-input
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || 'Digite um número'"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      type="number"
                      [error]="getFieldError(param.name)">
                    </ub-input>
                  }

                  <!-- Data -->
                  @if (param.type === 'date') {
                    <ub-input
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || 'dd/mm/aaaa'"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      type="date"
                      [error]="getFieldError(param.name)">
                    </ub-input>
                  }

                  <!-- Object -->
                  @if (param.type === 'object') {
                    <ub-object-editor
                      [label]="param.label || getDefaultLabel(param.name)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || 'Edite o objeto JSON aqui'"
                      [error]="getFieldError(param.name)">
                    </ub-object-editor>
                  }

                  <!-- Textarea para arrays complexos -->
                  @if (param.type === 'array') {
                    <ub-textarea
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="getComplexFieldPlaceholder(param)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || getComplexFieldHelp(param)"
                      type="textarea"
                      [rows]="4"
                      [error]="getFieldError(param.name)">
                    </ub-textarea>
                  }

                  <!-- Column Mapping -->
                  @if (param.type === 'column_mapping') {
                    <ub-column-mapping
                      [label]="param.label || getDefaultLabel(param.name)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || 'Configure o mapeamento entre colunas de origem e destino'"
                      [error]="getFieldError(param.name)">
                    </ub-column-mapping>
                  }

                  <!-- Series Config -->
                  @if (param.type === 'series_config') {
                    <ub-series-config
                      [label]="param.label || getDefaultLabel(param.name)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || 'Configure as séries que serão exibidas no gráfico'"
                      [error]="getFieldError(param.name)">
                    </ub-series-config>
                  }

                  <!-- Color Picker -->
                  @if (param.type === 'color') {
                    <ub-color-picker
                      [label]="param.label || getDefaultLabel(param.name)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description || ''"
                      [error]="getFieldError(param.name)">
                    </ub-color-picker>
                  }

                  <!-- Code Editor para SQL -->
                  @if (param.type === 'sql') {
                    <ub-code-editor
                      language="sql"
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || getDefaultPlaceholder(param)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description ?? ''"
                      [error]="getFieldError(param.name)">
                    </ub-code-editor>
                  }

                  <!-- Code Editor para JavaScript -->
                  @if (param.type === 'javascript') {
                    <ub-code-editor
                      language="javascript"
                      [label]="param.label || getDefaultLabel(param.name)"
                      [placeholder]="param.placeholder || getDefaultPlaceholder(param)"
                      [formControlName]="param.name"
                      [required]="param.required"
                      [disabled]="disabled"
                      [helpText]="param.description ?? ''"
                      [error]="getFieldError(param.name)">
                    </ub-code-editor>
                  }
                </div>
              }
            }
          </div>
        </div>
      }

      <!-- Botão de Salvar -->
      @if (showSubmitButton) {
        <div class="flex justify-content-end gap-2">
          <ub-button
            type="submit"
            [disabled]="form.invalid || disabled"
            [loading]="loading">
            {{ submitButtonText }}
          </ub-button>
        </div>
      }
    </form>
  }

  @if (loading) {
    <div class="loading-container">
      <div class="text-center p-6">
        <i class="pi pi-spin pi-spinner text-2xl text-blue-500 mb-2"></i>
        <p class="text-gray-500">Carregando parâmetros...</p>
      </div>
    </div>
  }
</div>
