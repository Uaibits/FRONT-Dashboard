<div class="dashboard-layout" [ngStyle]="{
  'height': viewHeight ? viewHeight + 'vh' : 'none'
}">

  <!-- Painel de Filtros Componentizado -->
  @if (!state.error && !showDashboardList) {
    <app-dashboard-filters
      [filters]="structure?.filters || []"
      [filterValues]="filterValues"
      [dashboardKey]="dashboardKey"
      [(collapsed)]="sidebarCollapsed"
      (apply)="applyFilters($event)"
      (clear)="clearFilters()"
    ></app-dashboard-filters>
  }

  <!-- Conteúdo Principal -->
  <div class="dashboard-main"
       [class.sidebar-collapsed]="sidebarCollapsed"
       [class.full-width]="showDashboardList || state.error">

    <!-- Lista de Dashboards (quando ativada) -->
    @if (showDashboardList && canShowDashboardList) {
      <div class="dashboard-list-view">
        <div class="list-header-section">
          <button class="back-to-dashboard-btn" (click)="toggleDashboardList()">
            <i class="bx bx-arrow-back"></i>
            Voltar ao Dashboard
          </button>
        </div>
        <app-dashboard-list
          [autoLoad]="true"
          [showHeader]="true"
          [columns]="3"
          (dashboardSelected)="onDashboardSelected($event)"
        ></app-dashboard-list>
      </div>
    }

    <!-- Visualização Normal do Dashboard -->
    @else {
      <!-- Header Superior com Título e Ações -->
      <div class="dashboard-header">
        <div class="header-left">
          @if (canShowDashboardList) {
            <button class="header-btn" (click)="goBack()" title="Ver todos os dashboards">
              <i class="bx bx-grid-alt"></i>
            </button>
          }
          <div class="header-info">
            <h1 class="dashboard-title">{{ dashboard?.name || 'Dashboard' }}</h1>
            @if (dashboard?.description) {
              <span class="dashboard-description">{{ dashboard.description }}</span>
            }
          </div>
        </div>
        <div class="header-right">
          @if (state.lastRefresh && autoRefreshEnabled && autoRefreshInterval > 0) {
            <span class="last-refresh" [class.refreshing]="state.backgroundRefreshing">
                <i class="bx" [ngClass]="state.backgroundRefreshing ? 'bx-loader-alt bx-spin' : 'bx-time-five'"></i>
              {{ getRefreshFormatted }}
              </span>
          }
          <button class="header-btn" (click)="refreshDashboard()" [disabled]="state.loading" title="Atualizar">
            <i class="bx bx-refresh" [class.spinning]="state.loading"></i>
          </button>
        </div>
      </div>

      <!-- Tela de Erro Elegante -->
      @if (state.error) {
        <div class="error-state">
          <div class="error-content">
            <div class="error-icon">
              <i class="bx bx-error-circle"></i>
            </div>
            <h2 class="error-title">Ops! Algo deu errado</h2>
            <p class="error-message">{{ state.error }}</p>
            <div class="error-actions">
              <button class="btn-primary" (click)="loadDashboardStructure()">
                <i class="bx bx-refresh"></i>
                Tentar Novamente
              </button>
              @if (canShowDashboardList) {
                <button class="btn-secondary" (click)="goBack()">
                  <i class="bx bx-grid-alt"></i>
                  Ver Outros Dashboards
                </button>
              }
            </div>
          </div>
        </div>
      }

      <!-- Loader Inicial -->
      @else if (state.loading && !filtersInitialized) {
        <div class="loading-state">
          <div class="loading-content">
            <div class="spinner"></div>
            <p>Carregando dashboard...</p>
          </div>
        </div>
      }

      <!-- Conteúdo do Dashboard -->
      @else {
        <!-- Aviso de Filtros Obrigatórios -->
        @if (filtersInitialized && !canLoadData()) {
          <div class="filters-warning">
            <i class="bx bx-info-circle"></i>
            <div class="warning-content">
              <strong>Filtros Obrigatórios</strong>
              <p>Preencha os seguintes filtros para visualizar os dados:
                <strong>{{ getMissingRequiredFilters().join(', ') }}</strong>
              </p>
            </div>
          </div>
        }

        <!-- Tabs de Seções -->
        @if (canLoadData() && structure && structure.sections && structure.sections.length > 1) {
          <div class="dashboard-tabs">
            @for (section of structure.sections; track section.section.id; let i = $index) {
              <button
                class="tab-item"
                [class.active]="activeSectionIndex === i"
                [class.loading]="state.loading && activeSectionIndex === i"
                (click)="setActiveTab(section.section.key, i); loadTabData(i)"
                [title]="section.section.description || section.section.title">

                @if (section.section.icon) {
                  <i [class]="'bx ' + section.section.icon"></i>
                }

                {{ section.section.title }}

                @if (section.widgets?.length) {
                  <span class="tab-badge">
                    {{ section.widgets.length }}
                  </span>
                }

                @if (state.loading && activeSectionIndex === i) {
                  <span class="tab-loading-indicator"></span>
                }
              </button>
            }
          </div>
        }

        <!-- Conteúdo da Seção Ativa -->
        @if (canLoadData() && structure && structure.sections && structure.sections[activeSectionIndex]) {

          <div class="dashboard-section">
            <!-- Header Compacto da Seção (somente se não tiver tabs ou em mobile) -->
            @if (structure.sections.length === 1) {
              <div class="section-header">
                <h3 class="section-title">
                  {{ structure.sections[activeSectionIndex].section.title }}
                </h3>
                @if (structure.sections[activeSectionIndex].section.description) {
                  <div class="section-description">{{ structure.sections[activeSectionIndex].section.description }}
                  </div>
                }
              </div>
            }

            <!-- Metric Cards (sempre em cima) -->
            @if (getMetricWidgets(structure.sections[activeSectionIndex].widgets).length > 0) {
              <div class="metrics-grid">
                @for (widget of getMetricWidgets(structure.sections[activeSectionIndex].widgets); track widget.id) {
                  <app-dashboard-metric-card
                    [widget]="widget"
                    [data]="getWidgetData(widget.key)"
                    [loading]="isWidgetLoading(widget.key)"
                    [error]="getWidgetError(widget.key)">
                  </app-dashboard-metric-card>
                }
              </div>
            }

            <!-- Charts e Tables organizados inteligentemente -->
            @if (getChartWidgets(structure.sections[activeSectionIndex].widgets).length > 0 || getTableWidgets(structure.sections[activeSectionIndex].widgets).length > 0) {
              @for (row of organizeWidgetsInRows(getChartWidgets(structure.sections[activeSectionIndex].widgets), getTableWidgets(structure.sections[activeSectionIndex].widgets)); track $index) {
                <div class="widgets-row">
                  @for (widget of row; track widget.id) {
                    <div class="widget-container" [ngStyle]="getWidgetStyle(widget)">
                      @if (widget.widget_type === 'table') {
                        <app-dashboard-table
                          [widget]="widget"
                          [data]="getWidgetData(widget.key)"
                          [loading]="isWidgetLoading(widget.key)"
                          [error]="getWidgetError(widget.key)">
                        </app-dashboard-table>
                      } @else {
                        <app-dashboard-chart
                          [widget]="widget"
                          [data]="getWidgetData(widget.key)"
                          [loading]="isWidgetLoading(widget.key)"
                          [error]="getWidgetError(widget.key)">
                        </app-dashboard-chart>
                      }
                    </div>
                  }
                </div>
              }
            }

          </div>
        } @else {
          <div class="dashboard-empty">
            <i class="bx bx-data"></i>
            <h4>Nenhuma seção configurada</h4>
            <p>Configure seções e widgets no editor do dashboard.</p>
          </div>
        }
      }
    }

  </div>

</div>
